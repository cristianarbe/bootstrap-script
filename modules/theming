#!/bin/bash

theming(){
    set -e
    set -x
    
    readonly USERHOME="/home/${SUDO_USER}"
    export DBUS_SESSION_BUS_ADDRESS="unix:path=/run/user/1000/bus"
    
    # Install theme
    goto "$USERHOME/.themes" -p
    get-extract https://github.com/vinceliuice/vimix-gtk-themes/archive/master.zip
    bash "$USERHOME/.themes/vimix-gtk-themes/Install"
    sed -i 's/<property name="theme" type="string" value=".*"\/>/<property name="theme" type="string" value="vimix-light-doder"\/>/g' ~/.config/xfce4/xfconf/xfce-perchannel-xml/xfwm4.xml
    su - "${SUDO_USER}" -c 'xfconf-query -c xfwm4 -p /general/theme -s "vimix-light-doder"'
    
    # Install icons
    goto "$USERHOME/.icons" -p
    get_extract https://github.com/vinceliuice/vimix-icon-theme/archive/master.zip
    bash "$USERHOME/.icons/vimix-icon-theme-master/install.sh"
    su - "${SUDO_USER}" -c "xfconf-query -c xsettings -p /Net/IconThemeName -s 'Vimix-Paper'"

    # Install cursor
    su - "${SUDO_USER}" -c 'xfconf-query -c xsettings -p /Gtk/CursorThemeName -s Breeze'
    
    # Install wallpaper
    goto "$USERHOME/Pictures/"
    wget https://raw.githubusercontent.com/cristianarbe/gettrisquel.org/master/images/banner.jpg
    # shellcheck disable=SC2016
    su - "${SUDO_USER}" -c 'xfconf-query -c xfce4-desktop -p /backdrop/screen0/monitor0/workspace0/last-image -s "$USERHOME/Pictures/banner.jpg"'
    
    # Install panel setup
    cd "/tmp/gnad/modules" || exit
    # Fix pulseaudio icon

    readonly XFCE_CONFIG="$USERHOME/.config/xfce4/xfconf/xfce-perchannel-xml"

    force_copy "gtk.css" "$USERHOME/.config/gtk-3.0/"
    force_copy "whiskermenu-1.rc" "$XFCE_CONFIG"
    force_copy "xfce4-keyboard-shortcuts.xml" "$XFCE_CONFIG"
    force_copy "xfce4-panel.xml" "$XFCE_CONFIG"
    force_copy "xfwm4.xml" "$XFCE_CONFIG"

    pkill xfconfd
    
    # Install keyboard shortcuts
    
    # Install font
    goto "$USERHOME/.fonts/"
    get-extract https://www.fontsquirrel.com/fonts/download/clear-sans zip
    su - "${SUDO_USER}" -c 'xfconf-query -c xsettings -p /Gtk/FontName -s "Clear Sans 12"'
    sed -i 's/<property name="title_font" type="string" value=".*"\/>/<property name="title_font" type="string" value="Clear Sans 12"\/>/g' ~/.config/xfce4/xfconf/xfce-perchannel-xml/xfwm4.xml

    # Make user own directories
    chown -R "${SUDO_USER}:${SUDO_USER}" "$USERHOME/.icons"
    chown -R "${SUDO_USER}:${SUDO_USER}" "$USERHOME/.themes"
    
    # Restart xfce
    xfce4-panel -r
    /usr/lib64/xfce4/xfconf/xfconfd &> /dev/null &
    
    read -pr "Changes will not be applied until you log out and log back in. You are going to be logged out now. Save your work and press enter to continue..."
    
    xfce4-session-logout
}
#!/bin/bash
set -x
# Load all modules
for file in modules/*.sh; do
    # shellcheck disable=SC1090
    source "$file"
done

FILE="$2"
export CONFIGPATH="${FILE%/*}"
SOURCEPATH="$( cd "$( dirname "${BASH_SOURCE[0]}" )" >/dev/null 2>&1 && pwd )"

main(){
    set -e
    
    if [[ $EUID -ne 0 ]]; then
        echo "This script must be run as root"
        exit 1
    fi
    
    if [[ "$1" == "install" ]]; then
        if [[ "$2" == "" ]]; then
            echo "Nothing specified."
        else
            # shellcheck disable=SC1090
            source "$2" "$2"
            
            [[ ! -d logs ]] && mkdir logs
            if [[ "$3" == "-y" ]]; then
                echo 'Installing packages...'
                install_apt >> /logs/gnad.log
                echo 'Installing extra packages...'
                extra_packages >>/logs/gnad.log
                echo 'Installing themes...'
                theming >>/logs/gnad.log
                echo 'Installing config...'
                dot_files >>/logs/gnad.log
                elif [[ "$3" == "-q" ]]; then
                install_apt
                extra_packages
                theming
                dot_files
                elif [[ "$3" == "" ]]; then
                ask "This installs the packages, do you want to proceed? [y/N]: " install_apt
                
                ask "This installs the packages that are not in the default repos, do \
                you want to proceed? [y/N]: " extra_packages
                
                ask "This will install the config files. This will \
                override your config files, do you want to proceed? [y/N]: " dot_files
                
                mkdir -p /tmp/gnad/
                cp "$SOURCEPATH/*" /tmp/gnad/ -r
                cd /tmp/gnad
                # shellcheck disable=SC2016
                ask "This install the themes, do you want to proceed? [y/N]: " 'su - ${SUDO_USER} -c "source modules/theming"'
            else
                echo "gnad: '$3' is not a gnad argument. See 'gnad --help'."
            fi
            
        fi
        elif [[ "$1" == "" ]]; then
        echo "usage: gnad <command> [<args>]"
    else
        echo "gnad: '$2' is not a gnad command. See 'gnad --help'."
    fi
}

main "$@"
#!/usr/bin/env bash
#
# Executable file of GNad
# TODO(cristianarbe): Always check return values and give informative return values.

readonly CONFIG_FILE="$1"
readonly CONFIG_FILE_PATH="${CONFIG_FILE%/*}"
readonly SCRIPT_PATH="$(
    cd "$(dirname "$0")"
    pwd -P
)"
readonly LIBRARIES="$SCRIPT_PATH/libraries"

set -e

# Load all libraries
for library in "$LIBRARIES"/*.sh; do
    # shellcheck disable=SC1090
    source "$library"
done

case $1 in
"-h" | "--help")
    cat "$LIBRARIES"/help.txt
    ;;
"--version")
    cat "$LIBRARIES"/version.txt
    ;;
"install")
    [[ $EUID -ne 0 ]] && echo "This program must be run as root" && exit 1
    # shellcheck disable=SC1090
    if [[ -z "$2" ]]; then
        source "$2"

        [[ ! -d logs ]] && mkdir logs

        echo 'Installing packages...'
        install_apt_packages >>logs/gnad.log
        echo 'Installing extra packages...'
        install_extra_packages >>logs/gnad.log
        echo 'Installing themes...'
        setup_appearance >>logs/gnad.log
        echo 'Install completed.'
        read -pr "You need to reboot now for the changes to take effect. \
Please save your work and press Enter to reboot"
        reboot
    else
        echo "gnad: missing file. See 'gnad --help' for more info."
    fi
    ;;
"get")
    if [[ -n "$2" ]]; then
        readonly REMOTE_CONFIG="https://raw.githubusercontent.com/cristianarbe/gnad/master/config.sh"
        url_valid=$(url_exists "$REMOTE_CONFIG")
        if [[ $url_valid == "true" ]]; then
            git clone --depth=1 https://github.com/"$2"
        else
            echo "fatal: config.sh file on '$2' not found"
        fi
    else
        echo "gnad: missing file. See 'gnad --help' for more info."
    fi
    ;;
*)
    echo "gnad: '$1': invalid option. See 'gnad --help' for more info."
    ;;
esac
